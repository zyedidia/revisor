local knit = require("knit")

local arch = "amd64"

local csrc = knit.join(knit.glob("*.c"), knit.glob(f"arch/$arch/*.c"))
local ssrc = knit.join(knit.glob("*.S"), knit.glob(f"arch/$arch/*.S"))
local obj = knit.join(knit.extrepl(csrc, ".c", ".o"), knit.extrepl(ssrc, ".S", ".o"))
obj = knit.prefix(obj, ".")

local picolib := build/install
local flags := -Wall -nostdlib -O2 -L$picolib/lib -I$picolib/include -lc -lgcc

return b{
    $ kernel.elf: $obj link/kernel.ld[I]
        gcc $input -o $output -Tlink/kernel.ld -static $flags

    $ .%.o:D[.%.d]: %.c
        gcc -O2 -MMD -c $input -o $output $flags
    $ .%.o: %.S
        gcc -c $input -o $output $flags
}
